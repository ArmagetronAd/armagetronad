#!/bin/bash

set -x

DIR=$1
test -z "${DIR}" && DIR="`pwd`"

BUNDLE="${DIR}/@progtitle@".app

mkdir -p "${BUNDLE}" || exit $?

# add launcher
cp `dirname $0`/entrypoint.sh "${BUNDLE}/@progtitle@" || exit $?
chmod 755 "${BUNDLE}/@progtitle@" || exit $?

# add plist with @v@ -> value and progtitle replacements
REL_SRCDIR=`echo @srcdir@ | sed -e s,^@top_builddir@/,,` || exit $?
sed < "${REL_SRCDIR}/Info.plist" > "${BUNDLE}/Info.plist" -e "s,Armagetron Advanced,@progtitle@,g" || exit $?
mkdir -p "${BUNDLE}/English.lproj" || exit $?
sed < "${REL_SRCDIR}/English.lproj/InfoPlist.strings.in" > "${BUNDLE}/English.lproj/InfoPlist.strings" \
-e "s,Armagetron Advanced,@progtitle@,g" \
-e "s,@vers[i]on@,@version@,g" \
-e "s,@year@,`date +%Y`,g" \
|| exit $?

# add icons
REL_TOP_SRCDIR=`echo @top_srcdir@ | sed -e s,^@top_builddir@/,,` || exit $?
cp "${REL_TOP_SRCDIR}/MacOS/Armagetron Advanced.icns" "${BUNDLE}/@progtitle@.icns"

# install game into bundle
DESTDIR="${BUNDLE}" make install || exit $?

# bundle libraries
(cd "${BUNDLE}"; dylibbundler -od -b -x "./@prefix@/bin/@progname@" -d "./@prefix@/lib/") || exit $?

# pack dmg

# mkdir pack
# cp -a "${BUNDLE}" pack || exit $?
# --sandbox-safe
# --icon "$ICON" 200 190 \
# DMG_SRC=pack
DMG_SRC=${BUNDLE}
rm -f "@progtitle@.dmg"
ICON="${REL_TOP_SRCDIR}/MacOS/Armagetron Advanced.icns"
BG="${REL_TOP_SRCDIR}/MacOS/background.png"
create-dmg \
	--volicon "$ICON" \
	--app-drop-link 470 180 --window-pos 200 112 --window-size 650 330 \
	--icon "@progtitle@.app" 220 80 \
	--icon-size 100 \
	--hide-extension "@progtitle@.app" \
	--background ${BG} \
	"@progtitle@.dmg" "${DMG_SRC}" || exit $?

# alternative, native way, less powerful
# hdiutil create -volname "@progtitle@" -srcfolder "${BUNDLE}" -ov -format UDIF "@progtitle@.dmg"

rm -rf "${DMG_SRC}"
